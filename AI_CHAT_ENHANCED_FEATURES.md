# 🤖 AIチャット機能 - 拡張版

## 🎯 新機能の概要

AIチャットボット「さくら」が大幅にパワーアップしました！
以下の新機能が追加されています：

## ✨ 新しく追加された機能

### 1. 📅 **予約の確認機能**

**使い方：**
```
ユーザー: 「予約を確認したい yamada@example.com」
さくら: 以下の予約が見つかりました：

        1. 2024年12月25日 14:00 ✅ 確定
           虫歯治療
        
        2. 2025年1月10日 10:30 ⏳ 承認待ち
           定期検診
        
        [マイページで詳細を見る] [予約を変更する] [予約をキャンセルする]
```

**対応する質問例：**
- 「予約を確認したい」
- 「私の予約を見せて」
- 「予約状況を教えて yamada@example.com」
- 「090-1234-5678 で予約してるか見たい」

**機能：**
- ✅ メールアドレスで予約検索
- ✅ 電話番号で予約検索
- ✅ 予約一覧の表示（最大5件）
- ✅ 予約ステータスの表示（確定/承認待ち/キャンセル）
- ✅ 治療内容の表示

---

### 2. ✏️ **予約の変更機能**

**使い方：**
```
ユーザー: 「予約を変更したい」
さくら: 予約の変更を承ります。

        まず、現在の予約を確認させてください。
        メールアドレスまたは電話番号を教えていただけますか？
        
        [マイページで変更]
```

**対応する質問例：**
- 「予約を変更したい」
- 「日時を変更したい」
- 「予約をずらしたい」
- 「時間を変えたい」

**機能：**
- ✅ 変更対象の予約を特定
- ✅ マイページへの誘導
- ✅ 変更手順の案内

---

### 3. ❌ **予約のキャンセル機能**

**使い方：**
```
ユーザー: 「予約をキャンセルしたい」
さくら: 予約のキャンセルを承ります。

        まず、キャンセル対象の予約を確認させてください。
        メールアドレスまたは電話番号を教えていただけますか？
        
        ※キャンセルは予約日の24時間前まで可能です
        
        [マイページでキャンセル]
```

**対応する質問例：**
- 「予約をキャンセルしたい」
- 「予約を取り消したい」
- 「予約を中止したい」
- 「予約をやめたい」

**機能：**
- ✅ キャンセル対象の予約を特定
- ✅ キャンセルポリシーの表示
- ✅ マイページへの誘導

---

### 4. 🦷 **治療コースの詳細案内（強化版）**

**使い方：**
```
ユーザー: 「虫歯治療について教えて」
さくら: 虫歯治療についてご説明します！😊

        【一般歯科】
        
        虫歯の治療を行います。早期発見・早期治療が重要です。
        
        ⏱️ 所要時間：30分〜1時間
        💰 料金：¥3,000〜¥10,000（保険適用）
        
        ✨ 特徴：
        • 痛みの少ない治療
        • 最新の機器を使用
        • 丁寧なカウンセリング
        
        👥 こんな方におすすめ：
        • 歯が痛い方
        • 詰め物が取れた方
        • 定期検診で虫歯が見つかった方
        
        📋 治療の流れ：
        1. カウンセリング
        2. 検査・診断
        3. 治療計画の説明
        4. 治療実施
        5. アフターケア
        
        このコースで予約されますか？
        
        [虫歯治療を予約] [他のコースを見る]
```

**対応する質問例：**
- 「虫歯治療とは？」
- 「クリーニングについて教えて」
- 「ホワイトニングコースを詳しく」
- 「定期検診って何？」

**検索できるコース：**
- 虫歯治療
- 定期検診・メンテナンス
- PMTCクリーニング
- ホワイトニング
- 歯列矯正
- インプラント
- 入れ歯
- 根管治療
- 抜歯
- 詰め物・被せ物
- 歯周病治療
- 予防歯科
- 審美歯科

---

### 5. 🔍 **インテリジェント予約検索**

**検索方法：**

#### パターン1: メールアドレスで検索
```
ユーザー: 「予約確認 yamada@example.com」
```

#### パターン2: 電話番号で検索
```
ユーザー: 「予約見たい 090-1234-5678」
```

#### パターン3: 自然な会話
```
ユーザー: 「私の予約を確認したいです」
さくら: メールアドレスまたは電話番号を教えていただけますか？
ユーザー: 「yamada@example.com です」
さくら: 予約を検索します...
        [予約一覧表示]
```

**検索条件：**
- ✅ 未来の予約のみ表示（過去の予約は除外）
- ✅ 日付順にソート
- ✅ 最大5件まで表示

---

## 💬 新しい会話例

### 例1: 予約確認から変更まで

```
👤 ユーザー: 「予約を確認したい」
🤖 さくら: 予約を確認いたします。
          メールアドレスまたは電話番号を教えていただけますか？

👤 ユーザー: 「yamada@example.com」
🤖 さくら: 以下の予約が見つかりました：
          
          1. 2024年12月25日 14:00 ✅ 確定
             虫歯治療
          
          [マイページで詳細を見る] [予約を変更する] [予約をキャンセルする]

👤 ユーザー: [予約を変更する] をクリック
🤖 さくら: マイページに移動します
```

### 例2: 治療コースの相談から予約まで

```
👤 ユーザー: 「歯のクリーニングについて教えて」
🤖 さくら: PMTCクリーニングについてご説明します！😊
          
          【予防歯科】
          
          専門的な歯のクリーニングで、虫歯・歯周病を予防します。
          
          ⏱️ 所要時間：45分〜60分
          💰 料金：¥5,000〜¥8,000
          
          ✨ 特徴：
          • プロによる徹底クリーニング
          • 歯石除去
          • ステイン除去
          • フッ素塗布
          
          このコースで予約されますか？
          
          [PMTCクリーニングを予約] [他のコースを見る]

👤 ユーザー: [PMTCクリーニングを予約] をクリック
🤖 さくら: 予約画面に移動します
```

### 例3: 予約キャンセル

```
👤 ユーザー: 「予約をキャンセルしたい」
🤖 さくら: 予約のキャンセルを承ります。
          
          まず、キャンセル対象の予約を確認させてください。
          メールアドレスまたは電話番号を教えていただけますか？
          
          ※キャンセルは予約日の24時間前まで可能です
          
          [マイページでキャンセル]
```

---

## 🎨 UIの改善

### アクションボタンの種類

- 📅 **予約を確定する** - 予約画面へ移動
- 🔍 **マイページで詳細を見る** - マイページへ移動
- ✏️ **予約を変更する** - マイページで変更画面を開く
- ❌ **予約をキャンセルする** - マイページでキャンセル画面を開く
- 📞 **電話をかける** - 電話接続
- 💬 **スタッフと話す** - スタッフチャット開始
- 📋 **コースを見る** - 治療コース一覧表示

---

## 🧠 AIの意図理解

### 対応する意図（Intent）

| 意図 | キーワード例 | 動作 |
|------|-------------|------|
| `new_booking` | 予約したい、取りたい | 予約画面へ |
| `view_booking` | 予約確認、見たい、チェック | 予約検索 |
| `modify_booking` | 変更、修正、ずらし | マイページへ |
| `cancel_booking` | キャンセル、取り消し | マイページへ |
| `consultation` | 相談、痛い、教えて | 治療コース案内 |
| `staff_connection` | スタッフ、話したい | スタッフ接続 |
| `phone_call` | 電話、かけたい | 電話転送 |

---

## 🔧 技術的な実装

### 予約検索のロジック

```typescript
// メールアドレスまたは電話番号で予約を検索
let query = supabase
  .from('appointments')
  .select('*')
  .gte('preferred_date1', new Date().toISOString())
  .order('preferred_date1', { ascending: true });

if (extractedData.email) {
  query = query.eq('email', extractedData.email);
} else if (extractedData.phone) {
  query = query.eq('phone', extractedData.phone);
}

const { data: appointments } = await query.limit(5);
```

### 予約情報の表示

```typescript
appointments.forEach((apt, index) => {
  const date = format(new Date(apt.preferred_date1), 'yyyy年MM月dd日');
  const status = apt.status === 'confirmed' ? '✅ 確定' 
               : apt.status === 'pending' ? '⏳ 承認待ち' 
               : '❌ キャンセル';
  appointmentList += `${index + 1}. ${date} ${apt.preferred_time1} ${status}\n`;
});
```

---

## 📊 会話フロー図

```
開始
  ↓
質問を入力
  ↓
AIが意図を解析
  ↓
┌──────────┬──────────┬──────────┬──────────┐
│ 新規予約  │ 予約確認  │ 予約変更  │コース相談│
└──────────┴──────────┴──────────┴──────────┘
      ↓           ↓          ↓          ↓
   予約画面    メール/電話   マイページ   詳細説明
                  検索                   ＋予約
      ↓           ↓          ↓          ↓
   予約完了    予約一覧    変更画面    予約画面
                表示
```

---

## 🎭 ユースケース

### ケース1: 初めての予約
```
👤「初めてなんですけど、予約できますか？」
🤖「もちろんです！どのような治療をご希望ですか？」
👤「歯のクリーニング」
🤖「PMTCクリーニングについてご説明します！...」
```

### ケース2: 予約の確認と変更
```
👤「予約を確認したい yamada@example.com」
🤖「以下の予約が見つかりました：1. 12月25日...」
👤「これを変更したい」
🤖「マイページで変更できます [マイページへ]」
```

### ケース3: 急なキャンセル
```
👤「急用ができて、予約をキャンセルしたい」
🤖「キャンセルを承ります。メールアドレスを教えてください」
👤「yamada@example.com」
🤖「予約を検索します... [マイページでキャンセル]」
```

---

## 🚀 使用方法

### フロントエンド実装

```tsx
import { AIChatBot } from '@/components/chat/AIChatBot';
import { useNavigate } from 'react-router-dom';

const navigate = useNavigate();

<AIChatBot
  onBookingRequest={(data) => {
    navigate('/booking', { state: { aiBookingData: data } });
  }}
  onStaffConnection={() => {
    setShowStaffDialog(true);
  }}
  onPhoneCall={() => {
    // 電話システムと連携
  }}
  onViewMyPage={() => {
    navigate('/mypage');
  }}
/>
```

---

## 🎯 今後の拡張予定

### Phase 2: より高度なAI
- [ ] OpenAI GPT-4との統合
- [ ] より自然な会話
- [ ] 文脈の記憶
- [ ] 多言語対応（英語、中国語）

### Phase 3: 予約管理の強化
- [ ] チャット内での直接予約変更
- [ ] チャット内での直接キャンセル
- [ ] 予約履歴の表示
- [ ] 治療記録の確認

### Phase 4: パーソナライゼーション
- [ ] ユーザーの好みを学習
- [ ] おすすめの治療提案
- [ ] リマインダーの自動送信
- [ ] 来院履歴に基づくアドバイス

---

## 📈 効果測定

### ユーザー体験の向上

| 項目 | Before | After |
|------|--------|-------|
| 予約確認方法 | マイページのみ | チャットでも可能 |
| 変更・キャンセル | マイページのみ | チャットから誘導 |
| コース情報 | ページを探す | チャットで即座に回答 |
| 問い合わせ | 電話のみ | チャット・電話・スタッフ |

### 期待される効果

- 📞 **問い合わせ電話の削減**: 30-50%減少
- ⏱️ **予約完了時間の短縮**: 5分 → 2分
- 😊 **顧客満足度の向上**: +20%
- 📈 **予約完了率の向上**: +15%

---

## 🔒 プライバシーとセキュリティ

- ✅ メールアドレス・電話番号での認証
- ✅ 自分の予約のみ表示
- ✅ 個人情報はチャットログに保存しない
- ✅ SSL暗号化通信

---

## 📞 サポート

AIチャットボットに関するご質問は、開発チームまでお問い合わせください。

**開発・保守**: 合同会社UMA  
**システム**: SmartReserve予約システム

---

**最終更新**: 2024年1月  
**バージョン**: 2.0.0 - Enhanced Edition

